---
date: 2025-08-08 14:23:12
title: é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼ˆAnolisOS-8.8-x86_64ï¼‰å†…ç½‘å‡çº§opensshè®°å½•
permalink: /pages/95722d
categories:
  - è¿ç»´
  - linux
coverImg: https://cdn.luoyuanxiang.top/img/bg/16.webp
---


# é˜¿é‡Œäº‘æœåŠ¡å™¨ï¼ˆAnolisOS-8.8-x86_64ï¼‰å†…ç½‘å‡çº§opensshè®°å½•

## 1. å‡†å¤‡å·¥ä½œ

### æµ‹è¯•æœºå™¨ç‰ˆæœ¬

![image](/assets/image-20250805101059-ckhb7pp.png)

### å‡†å¤‡ç¦»çº¿ä¾èµ–åŒ…

1. éœ€è¦è”ç½‘æ“ä½œ

```shell
dnf install -y yum-utils
```

2. å»ºç«‹ä¸‹è½½ç›®å½•

```shell
mkdir -p ~/offline-rpms
cd ~/offline-rpms
```

3. ä¸€æ¬¡æ€§ä¸‹è½½ç›®æ ‡åŒ…å’Œä¾èµ–åŒ…

```shell
dnf install --downloadonly --downloaddir=./rpms \
    gcc make openssl-devel zlib-devel pam-devel
```

ã€€ã€€å®Œæˆåæ‰€æœ‰ rpm ä½äº `~/offline-rpms/rpms/`

4. æ‰“åŒ…å¸¦èµ°

```shell
tar czf anolis8-dev.tar.gz rpms/
```

ã€€ã€€å°† `anolis8-dev.tar.gz` å¤åˆ¶åˆ° U ç›˜æˆ– scp åˆ°å†…ç½‘æœåŠ¡å™¨ã€‚

## 2. æŸ¥çœ‹ Linux ç³»ç»Ÿå½“å‰ OpenSSH ç‰ˆæœ¬

ã€€ã€€**æ“ä½œå‰ç½®è¯´æ˜**ï¼šä¸ºç¡®ä¿å‡çº§è¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸æ—¶å¯æ­£å¸¸å›é€€ï¼Œå»ºè®®åŒæ—¶å»ºç«‹ä¸¤ä¸ª SSH è¿æ¥ä¼šè¯ï¼ˆä¾‹å¦‚é€šè¿‡ä¸åŒç»ˆç«¯å·¥å…·æˆ–åŒä¸€å·¥å…·çš„ä¸¤ä¸ªæ ‡ç­¾é¡µè¿æ¥ç›®æ ‡æœåŠ¡å™¨ï¼‰ã€‚

ã€€ã€€**æŸ¥çœ‹å½“å‰ç‰ˆæœ¬æ­¥éª¤**ï¼š  
åœ¨å·²è¿æ¥çš„ç»ˆç«¯ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
ssh -V
```

![image](/assets/network-asset-20250805094752-20250805095554-v5d9v52.png)

ã€€ã€€æ‰§è¡Œåå¯æ˜¾ç¤ºå½“å‰ç³»ç»Ÿå®‰è£…çš„ OpenSSH å®¢æˆ·ç«¯ç‰ˆæœ¬ä¿¡æ¯ï¼ˆç¤ºä¾‹æ˜¾ç¤ºç‰ˆæœ¬ä¸º OpenSSH_7.4p1ï¼‰ã€‚

## 3. å‡†å¤‡ç¦»çº¿å®‰è£…åŒ…åŠä¾èµ–ç»„ä»¶

- å¤‡ç”¨ä¸‹è½½åœ°å€ï¼š[è“å¥äº‘](https://wwab.lanzouw.com/iocyE2w2w9ra)ï¼ˆåŒ…å« OpenSSH 10.0p2 ç‰ˆæœ¬åŠæ‰€éœ€ä¾èµ–ç»„ä»¶ï¼‰ï¼ˆå‚è€ƒè„šæœ¬ï¼‰
- ä¾èµ–ç»„ä»¶ï¼š[anolis8-dev.tar.gz](/assets/anolis8-dev.tar-20250806135750-4x5fjmn.gz)
- å‡çº§è„šæœ¬ï¼š[install_openssh_mzs_V9.sh](/assets/install_openssh_mzs_V9-20250806135814-4em0hzv.sh)
- openSSHåŒ…ï¼š[SSH_10.0p2-rpm.tar.gz](/assets/SSH_10.0p2-rpm.tar-20250806135825-8zwklgp.gz)

ã€€ã€€â€‹**æ–‡ä»¶ä¸Šä¼ ä¸æƒé™é…ç½®**ï¼š

1. å°†ä¾èµ–åŒ…ã€å‡çº§è„šæœ¬ã€openSSHåŒ…å…¨éƒ¨ä¸Šä¼ åˆ°æœåŠ¡å™¨/rootç›®å½•ä¸‹
2. å¯¹å®‰è£…è„šæœ¬èµ‹äºˆæ‰§è¡Œæƒé™ï¼š

    ```bash
    chmod +x install_openssh_mzs_V9.sh
    ```

ã€€ã€€**æ‰§è¡Œå‡çº§å®‰è£…**ï¼š  
åœ¨ç»ˆç«¯ä¸­è¿è¡Œå®‰è£…è„šæœ¬ï¼š

```bash
/root/install_openssh_mzs_V9.sh
```

ã€€ã€€è„šæœ¬å°†è‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

- æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ
- å¤‡ä»½æ–‡ä»¶
- å®‰è£…ä¾èµ–
- å®‰è£…æ–°ç‰ˆæœ¬ OpenSSH åŠä¾èµ–
- é‡å¯ sshd æœåŠ¡å¹¶é…ç½®å¼€æœºè‡ªå¯

![image](/assets/network-asset-20250805095344-20250805100008-ium47np.png)

ã€€ã€€**å®‰è£…è¿‡ç¨‹éªŒè¯**ï¼š  
è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šæ˜¾ç¤ºå„æ­¥éª¤è¿›åº¦ï¼Œæœ€ç»ˆå‡ºç° "å®‰è£…å®Œæˆ" æˆ–ç±»ä¼¼æç¤ºä¿¡æ¯ï¼ˆå¦‚æˆªå›¾æ‰€ç¤ºï¼‰ï¼Œè¡¨ç¤ºç¨‹åºåŒ…å®‰è£…æˆåŠŸã€‚

![image](/assets/network-asset-20250805095708-20250805100008-ebpy41s.png)

## 3. éªŒè¯å‡çº§ç»“æœ

ã€€ã€€**ç‰ˆæœ¬ç¡®è®¤**ï¼š  
å®‰è£…å®Œæˆåï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯æ–°ç‰ˆæœ¬ï¼š

```bash
ssh -V
```

ã€€ã€€è‹¥è¾“å‡ºä¿¡æ¯æ˜¾ç¤ºä¸º "OpenSSH_10.0p2"ï¼Œåˆ™è¡¨æ˜ç‰ˆæœ¬å‡çº§æˆåŠŸã€‚

![image](/assets/network-asset-20250805095751-20250805100009-5gywg6l.png)

ã€€ã€€**è¿æ¥æµ‹è¯•**ï¼š

1. å…³é—­å½“å‰ SSH è¿æ¥çª—å£
2. ä½¿ç”¨åŸè¿æ¥æ–¹å¼é‡æ–°å»ºç«‹ SSH ä¼šè¯
3. è‹¥èƒ½æ­£å¸¸ç™»å½•æœåŠ¡å™¨ï¼Œè¯´æ˜å‡çº§åçš„ OpenSSH æœåŠ¡å·¥ä½œæ­£å¸¸

## 4. æ‰§è¡Œè„šæœ¬å¤±è´¥å›é€€

ã€€ã€€åœ¨æ‰§è¡Œè„šæœ¬çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‡çº§å¤±è´¥ï¼Œè„šæœ¬åˆ™ä¼šè‡ªåŠ¨æ‰§è¡Œå›é€€æ“ä½œï¼Œä¼šå¸è½½å·²ç»å®‰è£…çš„åŒ…ï¼Œæ¢å¤å·²å¤‡ä»½çš„æ–‡ä»¶ç­‰ä¿¡æ¯

ã€€ã€€ä¹Ÿå¯ä»¥æ‰‹åŠ¨æ¢å¤

ã€€ã€€å¤‡ä»½æ–‡ä»¶åœ¨`/opt/openssh_backup_xxx`æ–‡ä»¶å¤¹ä¸‹ï¼Œ`xxx`å‡çº§çš„å½“å‰æ—¶é—´æˆ³

```text
/opt/openssh_backup_xxx
```

ã€€ã€€æ¨¡æ‹Ÿå‡çº§å¤±è´¥è„šæœ¬åšå›é€€æ“ä½œï¼Œè„šæœ¬å¦‚ä¸‹ï¼š

```shell
#!/bin/bash
set -euo pipefail

# ------------------------------------------------------
# OpenSSH ç¦»çº¿å®‰è£…è„šæœ¬ v1.0.3
# ä½œè€…ï¼šomanik
# æ—¥æœŸï¼š2025-04-23
# åŠŸèƒ½ï¼šå…¼å®¹æ£€æŸ¥ã€ç‰ˆæœ¬æ£€æµ‹ã€è‡ªåŠ¨å›æ»šã€æ—¥å¿—æœºåˆ¶ã€å¤‡ä»½éªŒè¯ã€SELinux æ£€æµ‹å’Œç¦ç”¨
# ------------------------------------------------------

# æ—¥å¿—é…ç½®
LOGFILE="$(pwd)/openssh_install_$(date +%Y%m%d%H%M%S).log"
exec > >(tee -a "$LOGFILE") 2>&1

log() {
    echo -e "\e[36m[$(date +'%Y-%m-%d %H:%M:%S')] $*\e[0m"
}

error_exit() {
    echo -e "\e[31mé”™è¯¯ï¼š$*\e[0m"
    exit 1
}

# æ£€æŸ¥å…³é”®å‘½ä»¤æ˜¯å¦å¯ç”¨
check_commands() {
    for cmd in tar rpm yum systemctl getfacl setfacl; do
        if ! command -v $cmd >/dev/null; then
            error_exit "å¿…éœ€å‘½ä»¤ $cmd ä¸å¯ç”¨"
        fi
    done
}

# 0. æ¬¢è¿æç¤ºä¸å…¼å®¹æ€§å£°æ˜
echo "------------------------------------------------------"
echo -e "\e[34mğŸ›   æ¬¢è¿ä½¿ç”¨ OpenSSH ç¦»çº¿å®‰è£…è„šæœ¬ï¼ˆv1.0.4ï¼‰\e[0m"
echo "------------------------------------------------------"
echo -e "\e[36mâœ”  æ”¯æŒç³»ç»Ÿï¼š\e[0m"
echo -e "\e[32m  - CentOS 7.xï¼ˆå†…æ ¸ 3.10.0-ï¼‰"
echo -e "  - CentOS 8.xï¼ˆå†…æ ¸ 4.18.0-ï¼‰"
echo -e "  - Rocky Linux 9.xï¼ˆå†…æ ¸ 5.14.0-ï¼‰"
echo -e "  - Alibaba Cloud Linux 3ï¼ˆå†…æ ¸ 5.10.0-ï¼‰"
echo -e "  - å…¶ä»– RedHat ç³»å‘è¡Œç‰ˆè¯·è‡ªæµ‹å…¼å®¹æ€§\e[0m"
echo -e "\e[36mâœ”  æ¶æ„è¦æ±‚ï¼š\e[0m \e[32mx86_64\e[0m"
echo
read -p $'\e[33mæ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ(y/n): \e[0m' choice
[[ ! "$choice" =~ ^[Yy]$ ]] && error_exit "å·²å–æ¶ˆå®‰è£…ã€‚"

check_commands

# 1. è§£å‹å®‰è£…åŒ…
log "è§£å‹ SSH å®‰è£…åŒ…..."
TAR_FILE="SSH_10.0p2-rpm.tar.gz"
[[ ! -f "$TAR_FILE" ]] && error_exit "$TAR_FILE ä¸å­˜åœ¨ï¼"
mkdir -p ./openssh_rpms
tar -xzf "$TAR_FILE" -C ./openssh_rpms
cd ./openssh_rpms

# 2. ç³»ç»Ÿæ£€æŸ¥
log "æ‰§è¡Œç³»ç»Ÿç¯å¢ƒæ£€æŸ¥..."
OS_ID=$(grep "^ID=" /etc/os-release | cut -d= -f2 | tr -d '"')
OS_VERSION_ID=$(grep "^VERSION_ID=" /etc/os-release | cut -d= -f2 | tr -d '"')
CPU_ARCH=$(uname -m)
KERNEL_VER=$(uname -r)

[[ "$CPU_ARCH" != "x86_64" ]] && error_exit "å½“å‰æ¶æ„ä¸º $CPU_ARCHï¼Œä»…æ”¯æŒ x86_64"

if [[ "$OS_ID" == "centos" && "$OS_VERSION_ID" =~ ^(7|8)$ ]]; then
    log "ç³»ç»Ÿç‰ˆæœ¬ç¬¦åˆè¦æ±‚ï¼šCentOS $OS_VERSION_ID"
elif [[ "$OS_ID" == "rocky" && "$OS_VERSION_ID" =~ ^9 ]]; then
    log "ç³»ç»Ÿç‰ˆæœ¬ç¬¦åˆè¦æ±‚ï¼šRocky Linux $OS_VERSION_ID"
else
    echo -e "\e[33må½“å‰ç³»ç»Ÿä¸º $OS_ID $OS_VERSION_IDï¼Œæœªåœ¨æ”¯æŒåˆ—è¡¨ä¸­ã€‚\e[0m"
    read -p $'\e[33mæ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ(y/n): \e[0m' choice
    [[ ! "$choice" =~ ^[Yy]$ ]] && error_exit "å·²å–æ¶ˆå®‰è£…ã€‚"
fi

if [[ ! "$KERNEL_VER" =~ ^(3\.10\.0|4\.18\.0|5\.14\.0)- ]]; then
    echo -e "\e[33må½“å‰å†…æ ¸ç‰ˆæœ¬ä¸º $KERNEL_VERï¼Œæœªåœ¨æ¨èç‰ˆæœ¬ä¸­ã€‚\e[0m"
    read -p $'\e[33mæ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ(y/n): \e[0m' choice
    [[ ! "$choice" =~ ^[Yy]$ ]] && error_exit "å·²å–æ¶ˆå®‰è£…ã€‚"
else
    log "å†…æ ¸ç‰ˆæœ¬ç¬¦åˆè¦æ±‚ï¼š$KERNEL_VER"
fi

# æ£€æŸ¥å¹¶ç¦ç”¨ SELinux
log "æ£€æµ‹ SELinux çŠ¶æ€..."
SELINUX_STATUS=$(getenforce 2>/dev/null || echo "Disabled")

if [[ "$SELINUX_STATUS" == "Enforcing" || "$SELINUX_STATUS" == "Permissive" ]]; then
    log "å½“å‰ SELinux çŠ¶æ€ä¸º $SELINUX_STATUSï¼Œå°†ä¸´æ—¶è®¾ç½®ä¸º Disabled"
    setenforce 0 || log "âš ï¸ æ— æ³•ä½¿ç”¨ setenforce å…³é—­ SELinuxï¼Œå¯èƒ½æœªå®‰è£…æˆ–éè¿è¡Œæ—¶å¯ä¿®æ”¹"

    if grep -q '^SELINUX=' /etc/selinux/config; then
        sed -i 's/^SELINUX=.*/SELINUX=disabled/' /etc/selinux/config
        log "å·²ä¿®æ”¹ /etc/selinux/configï¼Œç¦ç”¨ SELinuxï¼ˆéœ€é‡å¯ç”Ÿæ•ˆï¼‰"
    else
        log "âš ï¸ æœªæ‰¾åˆ° /etc/selinux/config æˆ–é…ç½®ä¸è§„èŒƒï¼Œè¯·æ‰‹åŠ¨ç¡®è®¤æ˜¯å¦å®Œå…¨ç¦ç”¨ SELinux"
    fi
else
    log "SELinux å·²å¤„äºå…³é—­çŠ¶æ€ï¼š$SELINUX_STATUS"
fi

# 3. æ£€æŸ¥æ˜¯å¦é‡å¤å®‰è£…ç‰ˆæœ¬
log "æ£€æŸ¥å½“å‰ç³»ç»Ÿå·²å®‰è£…çš„ OpenSSH ç‰ˆæœ¬..."
CURRENT_VER=$(rpm -q --qf '%{VERSION}-%{RELEASE}\n' openssh-server 2>/dev/null || echo "none")
TARGET_VER=$(rpm -q --qf '%{VERSION}-%{RELEASE}\n' -p openssh-server-*.rpm | head -n1)

if [[ "$CURRENT_VER" == "$TARGET_VER" ]]; then
    echo -e "\e[33må½“å‰ç³»ç»Ÿå·²å®‰è£…ç›¸åŒç‰ˆæœ¬ï¼ˆ$CURRENT_VERï¼‰ï¼Œæ— éœ€é‡å¤å®‰è£…ã€‚\e[0m"
    read -p $'\e[33mæ˜¯å¦å¼ºåˆ¶å®‰è£…æ­¤ç‰ˆæœ¬ï¼Ÿ(y/n): \e[0m' choice
    [[ ! "$choice" =~ ^[Yy]$ ]] && error_exit "å·²å–æ¶ˆå®‰è£…ã€‚"
fi

# 4. å¤‡ä»½æµç¨‹
log "å¼€å§‹å¤‡ä»½æµç¨‹..."
TIMESTAMP=$(date +"%Y%m%d%H%M%S")
BACKUP_DIR="/opt/openssh_backup_$TIMESTAMP"
mkdir -p "$BACKUP_DIR"

# å¤‡ä»½å…³é”®é…ç½®æ–‡ä»¶
log "å¤‡ä»½å…³é”®é…ç½®æ–‡ä»¶..."
CRITICAL_FILES=(
    /etc/ssh/sshd_config
    /etc/ssh/ssh_config
    /etc/pam.d/sshd
)

for file in "${CRITICAL_FILES[@]}"; do
    if [[ -f "$file" ]]; then
        cp -a "$file" "$BACKUP_DIR/"
        log "å·²å¤‡ä»½ï¼š$file"
    else
        log "âš ï¸ æœªæ‰¾åˆ°ï¼š$file"
    fi
done

# å¤‡ä»½æ•´ä¸ª/etc/sshç›®å½•
if [[ -d "/etc/ssh" ]]; then
    log "å¤‡ä»½æ•´ä¸ª/etc/sshç›®å½•..."
    cp -a /etc/ssh "$BACKUP_DIR/etc_ssh"
    
    # è®°å½•æƒé™å’ŒACL
    getfacl -R /etc/ssh > "$BACKUP_DIR/etc_ssh_acls.txt" 2>/dev/null
    find /etc/ssh -exec ls -la {} \; > "$BACKUP_DIR/etc_ssh_filelist.txt" 2>/dev/null
    log "å·²å¤‡ä»½/etc/sshç›®å½•æƒé™å’ŒACLä¿¡æ¯"

fi

# å¤‡ä»½æœåŠ¡æ–‡ä»¶
log "å¤‡ä»½æœåŠ¡ç›¸å…³æ–‡ä»¶..."
INIT_SYSTEM=$(cat /proc/1/comm)
log "æ£€æµ‹åˆ°ç³»ç»Ÿä½¿ç”¨çš„åˆå§‹åŒ–è¿›ç¨‹ä¸ºï¼š$INIT_SYSTEM"

SERVICE_FILES=(
    /etc/systemd/system/sshd.service
    /usr/lib/systemd/system/sshd.service
    /etc/rc.d/init.d/sshd
    /etc/init.d/sshd
)

for service_file in "${SERVICE_FILES[@]}"; do
    if [[ -f "$service_file" ]]; then
        cp -a "$service_file" "$BACKUP_DIR/"
        log "å·²å¤‡ä»½æœåŠ¡æ–‡ä»¶ï¼š$service_file"
    fi
done

# åŠ¨æ€è·å–äºŒè¿›åˆ¶è·¯å¾„å‡½æ•°
get_binary_path() {
    local name=$1
    # å°è¯•é€šè¿‡whichæŸ¥æ‰¾
    local path=$(command -v "$name" 2>/dev/null)
    [[ -n "$path" ]] && { echo "$path"; return 0; }

    # é€šè¿‡rpmæŸ¥è¯¢opensshç›¸å…³åŒ…
    local rpm_files=$(rpm -ql openssh-server openssh-clients openssh 2>/dev/null | grep -E "/${name}$")
    [[ -n "$rpm_files" ]] && { echo "$rpm_files" | head -n1; return 0; }

    # å¸¸è§é»˜è®¤è·¯å¾„å›é€€
    case "$name" in
        sshd)        echo "/usr/sbin/sshd" ;;
        ssh)         echo "/usr/bin/ssh" ;;
        scp)         echo "/usr/bin/scp" ;;
        sftp)        echo "/usr/bin/sftp" ;;
        ssh-keygen)  echo "/usr/bin/ssh-keygen" ;;
        sftp-server) echo "/usr/libexec/openssh/sftp-server" ;;
        *)           echo ""
    esac
}

# å¤‡ä»½äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆåŠ¨æ€è·å–è·¯å¾„ï¼‰
log "å¤‡ä»½äºŒè¿›åˆ¶æ–‡ä»¶å’Œåº“..."
BINARIES=()
BINARY_NAMES=(sshd ssh scp sftp ssh-keygen sftp-server)

for binary_name in "${BINARY_NAMES[@]}"; do
    path=$(get_binary_path "$binary_name")
    if [[ -e "$path" || -L "$path" ]]; then
        BINARIES+=("$path")
        log "å®šä½åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼š$binary_name â†’ $path"
    else
        log "âš ï¸ æœªæ‰¾åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ï¼š$binary_name"
    fi
done

# æ·»åŠ å…¶ä»–å¯èƒ½çš„æ‰‹åŠ¨æ£€æŸ¥è·¯å¾„
EXTRA_PATHS=(
    /usr/libexec/openssh/ssh-keysign
    /usr/libexec/openssh/ssh-pkcs11-helper
)
for path in "${EXTRA_PATHS[@]}"; do
    [[ -e "$path" ]] && BINARIES+=("$path")
done

# æ‰§è¡Œå¤‡ä»½
for binary in "${BINARIES[@]}"; do
    if [[ -f "$binary" || -L "$binary" ]]; then
        mkdir -p "$BACKUP_DIR/$(dirname "$binary")"
        cp -a "$binary" "$BACKUP_DIR/$binary"
        log "å·²å¤‡ä»½ï¼š$binary"
    fi
done

# è®°å½•å·²å®‰è£…çš„RPMåŒ…
log "è®°å½•å·²å®‰è£…çš„RPMåŒ…ä¿¡æ¯..."
rpm -qa --queryformat '%{NAME}-%{VERSION}-%{RELEASE}.%{ARCH}\n' openssh\* > "$BACKUP_DIR/installed_rpms.txt"
rpm -qa --queryformat '%{NAME}-%{VERSION}-%{RELEASE}.%{ARCH}\n' > "$BACKUP_DIR/all_installed_rpms.txt"

# éªŒè¯å¤‡ä»½å®Œæ•´æ€§
log "éªŒè¯å¤‡ä»½å®Œæ•´æ€§..."
BACKUP_VERIFICATION_FAILED=0
[[ ! -f "$BACKUP_DIR/etc_ssh/sshd_config" ]] && { log "âš ï¸ å…³é”®æ–‡ä»¶sshd_configå¤‡ä»½å¤±è´¥"; BACKUP_VERIFICATION_FAILED=1; }
[[ ! -f "$BACKUP_DIR/installed_rpms.txt" ]] && { log "âš ï¸ RPMåŒ…ä¿¡æ¯å¤‡ä»½å¤±è´¥"; BACKUP_VERIFICATION_FAILED=1; }

if [[ $BACKUP_VERIFICATION_FAILED -eq 1 ]]; then
    echo -e "\e[31må¤‡ä»½éªŒè¯å¤±è´¥ï¼å…³é”®æ–‡ä»¶æœªæˆåŠŸå¤‡ä»½ã€‚\e[0m"
    read -p $'\e[31mæ˜¯å¦å¼ºåˆ¶ç»§ç»­ï¼Ÿ(y/n): \e[0m' choice
    [[ ! "$choice" =~ ^[Yy]$ ]] && error_exit "å®‰è£…ä¸­æ­¢ï¼Œå¤‡ä»½éªŒè¯æœªé€šè¿‡ã€‚"
fi

log "å¤‡ä»½å®Œæˆï¼Œè·¯å¾„ï¼š$BACKUP_DIR"

# 5. å®‰è£…OpenSSHåŒ…
log "å¼€å§‹å®‰è£… OpenSSH åŒ…..."
PACKAGES=$(find . -type f \( -name "openssh-*.rpm" -o -name "openssh-*.deb" \))
[[ -z "$PACKAGES" ]] && error_exit "æ‰¾ä¸åˆ° openssh å®‰è£…åŒ…ï¼"

# æ¨¡æ‹Ÿå®‰è£…å¤±è´¥å¼€å…³ - è®¾ä¸ºtrueå¯è§¦å‘å›é€€æµç¨‹
export SIMULATE_INSTALL_FAILURE=true

if [[ "$SIMULATE_INSTALL_FAILURE" == "true" ]]; then
    log "âš ï¸ å·²å¯ç”¨å®‰è£…å¤±è´¥æ¨¡æ‹Ÿæ¨¡å¼ï¼Œå°†è§¦å‘å›é€€æµç¨‹..."
fi

# è®°å½•å®‰è£…å‰çŠ¶æ€
log "è®°å½•ç³»ç»Ÿå½“å‰çŠ¶æ€..."
PRE_INSTALL_STATE=$(mktemp -d)
BACKUP_PKG_LIST="$PRE_INSTALL_STATE/pkg.list"

# æ ¹æ®åŒ…ç®¡ç†å™¨è®°å½•çŠ¶æ€
if command -v rpm &>/dev/null; then
    rpm -qa --queryformat '%{NAME}-%{VERSION}-%{RELEASE}.%{ARCH}\n' > "$BACKUP_PKG_LIST"
elif command -v dpkg &>/dev/null; then
    dpkg -l | awk '/^ii/ {print $2"=" $3}' > "$BACKUP_PKG_LIST"
else
    error_exit "ä¸æ”¯æŒçš„åŒ…ç®¡ç†å™¨"
fi

# å®‰è£…è¿‡ç¨‹
log "å³å°†å®‰è£…çš„åŒ…ï¼š"
echo "$PACKAGES" | while read -r pkg; do
    log "  $(basename "$pkg")"
done

set +e
if [[ "$SIMULATE_INSTALL_FAILURE" == "true" ]]; then
    log "âŒ æ¨¡æ‹Ÿå®‰è£…å¤±è´¥..."
    INSTALL_STATUS=1
else
    if command -v yum &>/dev/null; then
        log "ä½¿ç”¨ yum å®‰è£…..."
        yum localinstall -y $PACKAGES >>"$LOGFILE" 2>&1
    elif command -v dpkg &>/dev/null; then
        log "ä½¿ç”¨ dpkg å®‰è£…..."
        dpkg -i $PACKAGES >>"$LOGFILE" 2>&1
        # è‡ªåŠ¨å¤„ç†ä¾èµ–
        apt-get -f install -y >>"$LOGFILE" 2>&1
    fi
    INSTALL_STATUS=$?
fi
set -e

# å®‰è£…å¤±è´¥å¤„ç†
if [[ $INSTALL_STATUS -ne 0 ]]; then
    echo -e "\e[31må®‰è£…å¤±è´¥ï¼Œå¼€å§‹æ‰§è¡Œå›é€€...\e[0m"
    
    # åŒ…å›é€€é€»è¾‘
    log "å›é€€è½¯ä»¶åŒ…å˜æ›´..."
    if command -v rpm &>/dev/null; then
        # RPM å›é€€
        CURRENT_RPMS=$(mktemp)
        rpm -qa --queryformat '%{NAME}-%{VERSION}-%{RELEASE}.%{ARCH}\n' > "$CURRENT_RPMS"
        NEWLY_INSTALLED=$(comm -13 "$BACKUP_PKG_LIST" "$CURRENT_RPMS" | cut -d- -f1 | sort -u)
        for pkg in $NEWLY_INSTALLED; do
            rpm -e --nodeps "$pkg" && log "å·²å¸è½½ $pkg" || log "å¸è½½ $pkg å¤±è´¥"
        done
        rm -f "$CURRENT_RPMS"
    elif command -v dpkg &>/dev/null; then
        # DEB å›é€€
        CURRENT_DEBS=$(mktemp)
        dpkg -l | awk '/^ii/ {print $2"=" $3}' > "$CURRENT_DEBS"
        NEWLY_INSTALLED=$(comm -13 "$BACKUP_PKG_LIST" "$CURRENT_DEBS" | cut -d= -f1)
        for pkg in $NEWLY_INSTALLED; do
            dpkg --purge "$pkg" && log "å·²å¸è½½ $pkg" || log "å¸è½½ $pkg å¤±è´¥"
        done
        # æ¢å¤è‡ªåŠ¨å®‰è£…çš„ä¾èµ–
        apt-get autoremove -y >>"$LOGFILE" 2>&1
        rm -f "$CURRENT_DEBS"
    fi
    
    # é…ç½®æ–‡ä»¶æ¢å¤å¢å¼º
    log "æ¢å¤é…ç½®æ–‡ä»¶..."
    if [[ -d "$BACKUP_DIR/etc_ssh" ]]; then
        # å®‰å…¨åˆ é™¤å¹¶æ¢å¤
        rm -rf /etc/ssh.rollback
        mv /etc/ssh /etc/ssh.rollback
        cp -a "$BACKUP_DIR/etc_ssh" /etc/ssh
        
        # æƒé™æ¢å¤
        if [[ -f "$BACKUP_DIR/etc_ssh_acls.txt" ]]; then
            log "æ¢å¤ACLæƒé™..."
            setfacl --restore="$BACKUP_DIR/etc_ssh_acls.txt" 2>/dev/null || :
        fi
        
        log "æ¢å¤æ–‡ä»¶æ—¶é—´æˆ³..."
while IFS= read -r line; do
    file=$(echo "$line" | awk '{print $NF}')  # ä½¿ç”¨æœ€åä¸€ä¸ªå­—æ®µï¼Œæ”¯æŒè·¯å¾„ä¸­æœ‰ç©ºæ ¼çš„æƒ…å†µ
    timestamp=$(echo "$line" | awk '{print $6" "$7" "$8}')
    echo "æ¢å¤ $file åˆ° $timestamp"
    touch -d "$timestamp" "$file" 2>/dev/null || true
done < "$BACKUP_DIR/etc_ssh_filelist.txt"

    fi
    
    # æœåŠ¡æ–‡ä»¶æ¢å¤ä¼˜åŒ–
    log "æ¢å¤æœåŠ¡æ–‡ä»¶..."
    mapfile -t SERVICE_FILES < <(find "$BACKUP_DIR" -type f \( -path "*/sshd.service" -o -path "*/sshd.init" \))
    for backup_file in "${SERVICE_FILES[@]}"; do
        target_file="/${backup_file#$BACKUP_DIR/}"
        mkdir -p "$(dirname "$target_file")"
        if cp -a "$backup_file" "$target_file"; then
            log "å·²æ¢å¤æœåŠ¡æ–‡ä»¶ï¼š$target_file"
        else
            log "âš ï¸ æ¢å¤å¤±è´¥ï¼š$target_file"
        fi
    done
    
    # äºŒè¿›åˆ¶æ–‡ä»¶æ¢å¤å¼ºåŒ–
    log "æ¢å¤äºŒè¿›åˆ¶æ–‡ä»¶..."
    while IFS= read -r binary; do
        src_path="$BACKUP_DIR/$binary"
        dest_path="/$binary"
        if [[ -f "$src_path" ]]; then
            mkdir -p "$(dirname "$dest_path")"
            if cp -a "$src_path" "$dest_path"; then
                log "å·²æ¢å¤äºŒè¿›åˆ¶æ–‡ä»¶ï¼š$dest_path"
                # æ¢å¤åŠ¨æ€åº“ä¾èµ–
                if ldd "$dest_path" &>/dev/null; then
                    ldd "$dest_path" | awk '/=> \// {print $3}' | while read -r lib; do
                        lib_src="$BACKUP_DIR/libs/${lib#/}"
                        if [[ -f "$lib_src" ]]; then
                            mkdir -p "$(dirname "$lib")"
                            cp -a "$lib_src" "$lib" && log "å·²æ¢å¤åº“æ–‡ä»¶ï¼š$lib"
                        fi
                    done
                fi
            fi
        fi
    done < <(find "$BACKUP_DIR/usr" -type f -executable)
    
    # ç³»ç»Ÿé‡è½½ä¼˜åŒ–
    log "é‡æ–°åŠ è½½ç³»ç»Ÿé…ç½®..."
    case "$INIT_SYSTEM" in
        systemd)
            systemctl daemon-reexec
            systemctl daemon-reload
            ;;
        init)
            service sshd reload
            ;;
        *)
            /etc/init.d/sshd reload
            ;;
    esac
    
    # æœåŠ¡çŠ¶æ€æ£€æŸ¥
    log "éªŒè¯æœåŠ¡çŠ¶æ€..."
    if command -v sshd &>/dev/null; then
        if systemctl is-active sshd &>/dev/null || pgrep sshd &>/dev/null; then
            log "SSHæœåŠ¡æ­£åœ¨è¿è¡Œ"
        else
            log "å°è¯•å¯åŠ¨SSHæœåŠ¡..."
            if systemctl start sshd || service sshd start || /etc/init.d/sshd start; then
                log "SSHæœåŠ¡å¯åŠ¨æˆåŠŸ"
            else
                log "âš ï¸ SSHæœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
            fi
        fi
    else
        log "âš ï¸ sshd äºŒè¿›åˆ¶æ–‡ä»¶ä¸å­˜åœ¨"
    fi
    
    error_exit "å·²å®Œæˆå›æ»šæ“ä½œï¼ŒOpenSSHå®‰è£…å¤±è´¥ï¼Œç³»ç»Ÿå·²æ¢å¤åŸçŠ¶ã€‚"
fi

rm -rf "$PRE_INSTALL_STATE"

# 6. é…ç½®ä¿®å¤ä¸æƒé™ä¿®å¤
log "éªŒè¯é…ç½®å¹¶ä¿®å¤SSHå¯†é’¥æ–‡ä»¶æƒé™..."
SSHD_CONFIG="/etc/ssh/sshd_config"

[[ -f "$SSHD_CONFIG" ]] && sed -i '/^StrictScpCheck/d' "$SSHD_CONFIG"

# æ£€æŸ¥å¹¶è¿½åŠ å¿…è¦çš„SSHé…ç½®é¡¹
log "æ£€æŸ¥SSHç™»å½•é…ç½®é¡¹..."
missing_config=0

grep -qE '^\s*PermitRootLogin\s+yes' "$SSHD_CONFIG" || {
    log "ç¼ºå°‘PermitRootLogin yesï¼Œæ­£åœ¨æ·»åŠ ..."
    echo "PermitRootLogin yes" >> "$SSHD_CONFIG"
    missing_config=1
}

grep -qE '^\s*PasswordAuthentication\s+yes' "$SSHD_CONFIG" || {
    log "ç¼ºå°‘PasswordAuthentication yesï¼Œæ­£åœ¨æ·»åŠ ..."
    echo "PasswordAuthentication yes" >> "$SSHD_CONFIG"
    missing_config=1
}

[[ $missing_config -eq 1 ]] && log "SSHé…ç½®å·²è¡¥å……ï¼Œè¯·ç¡®è®¤å®‰å…¨ç­–ç•¥æ˜¯å¦å…è®¸ã€‚"

# ä¿®å¤SSHä¸»æœºå¯†é’¥æƒé™
log "ä¿®å¤SSHä¸»æœºå¯†é’¥æƒé™..."
for key in /etc/ssh/ssh_host_*; do
    if [[ -f "$key" ]]; then
        chmod 600 "$key"
        log "å·²ä¿®å¤æƒé™ï¼š$key"
    fi
done

# éªŒè¯é…ç½®æ˜¯å¦æ­£ç¡®
if sshd -t; then
    log "é…ç½®éªŒè¯é€šè¿‡ï¼Œé‡å¯æœåŠ¡..."
    systemctl daemon-reexec
    systemctl daemon-reload
    systemctl restart sshd
else
    error_exit "é…ç½®éªŒè¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥ $SSHD_CONFIGã€‚"
fi

# 7. æ˜¾ç¤ºçŠ¶æ€ä¸æ—¥å¿—ä½ç½®
systemctl status sshd --no-pager
log "ğŸ‰ SSHå®‰è£…æˆåŠŸï¼å¤‡ä»½è·¯å¾„ï¼š$BACKUP_DIR"
log "ğŸ“„ å®‰è£…æ—¥å¿—ä¿å­˜åœ¨ï¼š$LOGFILE"
```

ã€€ã€€æ¨¡æ‹Ÿç»“æœå¦‚ä¸‹ï¼š

![image](/assets/image-20250805112206-eq45th5.png)

![image](/assets/image-20250805112223-z1dlxgg.png)
